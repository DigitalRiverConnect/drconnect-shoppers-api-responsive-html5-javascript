define("Class",[],function(){var d=!1,a=/xyz/.test(function(){})?/\b_super\b/:/.*/,c=function(){};c.extend=function(b){function c(){!d&&this.init&&this.init.apply(this,arguments)}var f=this.prototype;d=!0;var h=new this;d=!1;for(var g in b)h[g]=typeof b[g]=="function"&&typeof f[g]=="function"&&a.test(b[g])?function(a,b){return function(){var c=this._super;this._super=f[a];var e=b.apply(this,arguments);this._super=c;return e}}(g,b[g]):b[g];c.prototype=h;c.prototype.constructor=c;c.extend=arguments.callee;
return c};return c});
define("AsyncRequester",["Class"],function(d){return d.extend({init:function(a){this.session=a},makeRequest:function(a,c){var b=this,e=a.fail(function(a){return b.invalidTokenHandler(a)}).fail(function(a){return b.adaptError(a)});if(c){var f=this.getCallbacks(c);e.then(f.success,f.error).end()}else return e},invalidTokenHandler:function(a){if(a.status==0)a.status=401,a.error={},a.error.errors={},a.error.errors.error={code:"Unauthorized",description:"Invalid token"},this.session.disconnect();throw a;
},failRequest:function(a,c){if(c)cb.error(a);else{var b=Q.defer();b.reject(a);return b.promise}},load:function(a,c,b){return a&&a.uri?this.makeRequest(this.session.retrieve(a.uri,c),b):this.failRequest("The resource does not provide a URI",b)},adaptError:function(a){if(a.error&&a.error.errors&&a.error.errors.error)a.error=a.error.errors.error;throw{status:a.status,details:a};},getCallbacks:function(a){var c=this,b={};a||(a={});b.error=function(b){a.error&&typeof a.error==="function"?(a.error(b),a.callDefaultErrorHandler&&
c.options.error&&typeof c.options.error==="function"&&c.options.error(b)):c.options.error&&typeof c.options.error==="function"&&c.options.error(b)};b.success=function(b){a.success&&typeof a.success==="function"?a.success(b):a&&typeof a==="function"?a(b):c.options.success&&typeof c.options.success==="function"&&c.options.success(b)};return b}})});
define("service/BaseService",["AsyncRequester"],function(d){return d.extend({init:function(a){if(!a)throw"Client must be instantiated";this._super(a.session);this.client=a;this.options=a.options},get:function(a,c,b){return this.makeRequest(this.session.retrieve(this.uri+"/"+a,c),b)},list:function(a,c){return this.makeRequest(this.session.retrieve(this.uri,a),c)},parseResponse:function(a){return a},replaceTemplate:function(a,c){for(var b in c)a=a.replace("{"+b+"}",c[b]);return a}})});
define("Util",[],function(){return{namespace:function(d){for(var d=d.split("."),a=window,c="",b=0,e=d.length;b<e;b++)c=d[b],a[c]=a[c]||{},a=a[c];return a},is_array:function(d){return typeof d=="object"&&d instanceof Array},is_string:function(d){return typeof d=="string"},getAttribute:function(d,a){for(var c=a.split("."),b=d,e="",f=0,h=c.length;f<h;f++)e=c[f],b[e]=b[e]||{},b=b[e];return b},setAttribute:function(d,a,c){for(var a=a.split("."),b="",e=0,f=a.length;e<f-1;e++)b=a[e],d[b]=d[b]||{},d=d[b];
d[a[f-1]]=c},merge:function(d,a){for(var c in a)d[c]=a[c];return d},isAbsoluteUri:function(d){return d.lastIndexOf("http",0)===0},Error:function(d){this.message=d},getQueryStringParam:function(d,a){var c=RegExp("[\\?&]"+a+"=([^&#]*)").exec(d);return!c?"":c[1]||0},getCurrentPath:function(){var d=window.location.href.replace(window.location.hash,"");return d.substring(0,d.lastIndexOf("/"))}}});
define("Config",["Util"],function(d){var a={authMode:{POPUP:"POPUP",IFRAME:"IFRAME",WINDOW:"WINDOW"}};a.config={AUTH_FRAME_ID:"drApiAuthFrame",DEFAULT_REDIRECT_URI:d.getCurrentPath()+"/drapi-auth.html",EDIT_ACCOUNT_FRAME_ID:"drEditAccountFrame",EDIT_ACCOUNT_REDIRECT_URI:d.getCurrentPath()+"/drapi-editaccount.html"};a.connection={};a.connection.URI={BASE_URL:null,DEV_BASE_URL:"http://23.21.197.49/",PRD_BASE_URL:"http://23.21.197.49/",VERSION:"v1",ANONYMOUS_LOGIN:"oauth20/token",LOGIN:"oauth20/authorize"};
a.connection.TYPE={XML:"1",JSON:"2",TEXT:"3",UNSIGNED_BYTES:"4"};a.service={};a.service.URI={CATEGORIES:"shoppers/me/categories",PRODUCTS:"shoppers/me/products",PRODUCTS_BY_CATEGORY:"shoppers/me/categories/{categoryId}/products",OFFERS:"shoppers/me/point-of-promotions/{popName}/offers",PRODUCT_OFFERS:"shoppers/me/point-of-promotions/{popName}/offers/{offerId}/product-offers",PRODUCTS_SEARCH:"/shoppers/me/product-search",CART:"shoppers/me/carts/active",CART_LINE_ITEMS:"shoppers/me/carts/active/line-items",
CART_OFFERS:"shoppers/me/carts/active/point-of-promotions/{popName}/offers",CART_APPLY_SHOPPER:"shoppers/me/carts/active/apply-shopper",CART_SHIPPING_OPTIONS:"shoppers/me/carts/active/shipping-options",CART_APPLY_SHIPPING_OPTION:"shoppers/me/carts/active/apply-shipping-option",SHOPPER:"shoppers/me",SHOPPER_PAYMENT_OPTION:"shoppers/me/payment-options",SHOPPER_ACCOUNT:"shoppers/me/account",ORDERS:"shoppers/me/orders",ORDER_SHIPPING_ADDRESS:"shoppers/me/orders/{orderId}/shipping-address",ORDER_BILLING_ADDRESS:"shoppers/me/orders/{orderId}/billing-address",
ADDRESS:"shoppers/me/addresses"};return a});
define("view/EditAccountIFrameView",["Config"],function(d){var a=function(a,b,e){this.uri=a+"?redirect_uri="+encodeURIComponent(b);this.id=d.config.EDIT_ACCOUNT_FRAME_ID;this.parentElementId=e.elementId};a.prototype.open=function(a,b){var e=document.getElementById(this.id);e||(e=this.create());var f=this.uri+"&dr_limited_token="+a;e.onload=function(){this.src==f&&b&&b()};e.src=f};a.prototype.close=function(){console.log("Closing Edit Account IFrame");var a=document.getElementById(this.id);a&&a.parentNode.removeChild(a)};
a.prototype.create=function(){var a=document.createElement("iframe");a.id=this.id;a.width="100%";a.height="100%";a.style.margin="auto";a.style.border="none";a.scrolling="auto";(this.parentElementId!=""?document.getElementById(this.parentElementId):document.body).appendChild(a);return a};return a});
define("service/ShopperService",["service/BaseService","Config","q","view/EditAccountIFrameView"],function(d,a,c,b){var e=d.extend({uri:a.service.URI.SHOPPER,get:function(a,b){return this.makeRequest(this.session.retrieve(this.uri,a),b)},getAddresses:function(b,c){return this.makeRequest(this.session.retrieve(a.service.URI.ADDRESS,b),c)},getPaymentOptions:function(b,c){return this.makeRequest(this.session.retrieve(a.service.URI.SHOPPER_PAYMENT_OPTION,b),c)},editAccount:function(f,h,d){var i=a.connection.URI.BASE_URL+
a.connection.URI.VERSION+"/"+a.service.URI.SHOPPER_ACCOUNT,j=c.defer();this.view=new b(i,a.config.EDIT_ACCOUNT_REDIRECT_URI,f);e.currentRequest={defer:j,view:this.view};this.view.open(this.session.token,d);return this.makeRequest(j.promise,h)}});e.editCallback=function(){var a=e.currentRequest;if(a)a.view.close(),a.view=null,e.currentRequest=null,window.focus(),a.defer.resolve()};return e});
define("view/AuthViewUtil",[],function(){return{buildUriFromOptions:function(d,a,c){return d+"?redirect_uri="+encodeURIComponent(a)+"&response_type=token&client_id="+c.client_id},getUriWithToken:function(d,a){return d+"&dr_limited_token="+a}}});
define("view/AuthWindowView",["view/AuthViewUtil","Config"],function(d,a){var c=function(b,c,f){this.uri=d.buildUriFromOptions(b,c,f);this.id=a.config.AUTH_FRAME_ID};c.prototype.open=function(a){this.popup&&this.close();a=d.getUriWithToken(this.uri,a);this.popup=window.open(a,this.id);this.popup.focus()};c.prototype.close=function(){console.log("Closing Auth popup");if(this.popup)this.popup.close(),this.popup=null};return c});
define("view/AuthIFrameView",["view/AuthViewUtil","Config"],function(d,a){var c=function(b,c,f){this.uri=d.buildUriFromOptions(b,c,f);this.id=a.config.AUTH_FRAME_ID;this.parentElementId=f.elementId};c.prototype.open=function(a,c){var f=document.getElementById(this.id);f||(f=this.create());var h=d.getUriWithToken(this.uri,a);f.onload=function(){this.src==h&&c&&c()};f.src=h};c.prototype.close=function(){console.log("Closing Auth IFrame");var a=document.getElementById(this.id);a&&a.parentNode.removeChild(a)};
c.prototype.create=function(){var a=document.createElement("iframe");a.id=this.id;a.width="100%";a.height="100%";a.style.margin="auto";a.style.border="none";a.scrolling="auto";(this.parentElementId!=""?document.getElementById(this.parentElementId):document.body).appendChild(a);return a};c.prototype.AddOnLoadedHandler=function(){};return c});
define("auth/AuthManager",["q","view/AuthWindowView","view/AuthIFrameView"],function(d,a,c){var b=function(b,f){this.redirectUri=f.authRedirectUrl;this.uri=b;this.views={IFRAME:c,WINDOW:a};this.view=this.createView(f.strategy,f)};b.prototype.createView=function(a,b){return new this.views[a](this.uri,this.redirectUri,b)};b.prototype.login=function(a,c){var h=d.defer();b.currentRequest={defer:h,view:this.view};this.view.open(a,c);return h.promise};b.authCallback=function(a,c,d,g){var i=b.currentRequest;
if(i)i.view.close(),i.view=null,b.currentRequest=null,window.focus(),d?i.defer.reject({error:d,error_description:g}):i.defer.resolve({token:a,expires_in:c})};b.getError=function(a){switch(a){case "invalid_request":return{error:a,error_description:"Invalid Request. Please check the parameters."}}};return b});
define("Ajax",["q"],function(d){return{doAjax:function(a,c,b,e,f){var h=d.defer(),g=this.createRequest();g.onreadystatechange=function(){if(g.readyState==4){var a=g.responseText;a!=""&&(a=JSON.parse(a));g.status!=""&&g.status<300?h.resolve(a):h.reject({status:g.status,error:a.Exception?a.Exception.Error:a})}};this.sendRequest(a,c,b,e,g,f);return h.promise},createRequest:function(){try{req=new XMLHttpRequest}catch(a){try{req=new ActiveXObject("Msxml2.XMLHTTP")}catch(c){try{req=new ActiveXObject("Microsoft.XMLHTTP")}catch(b){req=
!1}}}return req},sendRequest:function(a,c,b,e,f,d){var b=this.utf8Encode(this.getQueryString(b)),g=a;b!=""&&(g+=(a.indexOf("?")>0?"&":"?")+b);f.open(c,g,!0);f=this.setHeader(e,f);d?(e["Content-Type"]=="application/x-www-form-urlencoded"&&(d=this.utf8Encode(this.getQueryString(d))),f.send(d)):f.send()},getQueryString:function(a){var c="",b;for(b in a)b&&(c+=b+"="+a[b]+"&");return c.substring(0,c.length-1)},setHeader:function(a,c){c.setRequestHeader("Accept","application/json");for(var b in a)c.setRequestHeader(b,
a[b]);return c},utf8Encode:function(a){for(var a=a.replace(/\r\n/g,"\n"),c="",b=0;b<a.length;b++){var d=a.charCodeAt(b);d<128?c+=String.fromCharCode(d):(d>127&&d<2048?c+=String.fromCharCode(d>>6|192):(c+=String.fromCharCode(d>>12|224),c+=String.fromCharCode(d>>6&63|128)),c+=String.fromCharCode(d&63|128))}return c},isEmpty:function(a){for(var c in a)return!1;return!0}}});
define("connection/Connection",["Config","Ajax","Util"],function(d,a,c){var b=function(){console.log("Using real Connection");this.baseUrl=d.connection.URI.BASE_URL+d.connection.URI.VERSION+"/"};b.prototype.create=function(a,b,c,d){return this.request(a,"POST",b,c,d)};b.prototype.retrieve=function(a,b,c,d){return this.request(a,"GET",b,c,d)};b.prototype.update=function(a,b,c){return this.request(a,"PUT",b,c)};b.prototype.remove=function(a,b,c){return this.request(a,"DELETE",b,c)};b.prototype.submitForm=
function(a,b,c){c=c||{};c["Content-Type"]="application/x-www-form-urlencoded";return this.request(a,"POST",{},c,b)};b.prototype.request=function(b,d,h,g,i){c.isAbsoluteUri(b)||(b=this.baseUrl+b);return a.doAjax(b,d,h,g,i)};return b});
define("connection/Session",["Config","connection/Connection","auth/AuthManager","q"],function(d,a,c,b){var e=function(b,e){this.apikey=b;this.connection=new a;this.authManager=new c(d.connection.URI.BASE_URL+d.connection.URI.LOGIN,e);this.reset()};e.prototype.createErrorPromise=function(a){console.log("Operation not allowed: "+a);var a=this.createServerErrorResponse(),c=b.defer();c.reject(a);return c.promise};e.prototype.createDisconnectedError=function(){return this.createErrorPromise("You must be connected to the server in order to use the API")};
e.prototype.createServerErrorResponse=function(){var a={status:500,error:{}};a.error.errors={};a.error.errors.error={code:"server_error",description:"Service Temporaly Unavailable. Please try again later or contact the System Administrator."};return a};e.prototype.create=function(a,b){if(!this.connected)return this.createDisconnectedError();var c={};c.Authorization="bearer "+this.token;return this.connection.create(a,b,c).then(function(a){for(var b in a)if(b)return a[b]})};e.prototype.remove=function(a,
b){if(!this.connected)return this.createDisconnectedError();var c={};c.Authorization="bearer "+this.token;b||(b={});b.client_id=this.apikey;return this.connection.remove(a,b,c).then(function(a){for(var b in a)if(b)return a[b]})};e.prototype.retrieve=function(a,b){if(!this.connected)return this.createDisconnectedError();var c={};c.Authorization="bearer "+this.token;b||(b={});b.client_id=this.apikey;return this.connection.retrieve(a,b,c).then(function(a){for(var b in a)if(b)return a[b]})};e.prototype.errorHandle=
function(){};e.prototype.anonymousLogin=function(){var a=d.connection.URI.BASE_URL+d.connection.URI.ANONYMOUS_LOGIN,b=this,c=new Date;if(this.refreshToken)return this.getRefreshToken();c={client_id:this.apikey,ts:c.getTime(),grant_type:"password",username:"anonymous",password:"anonymous"};return this.connection.submitForm(a,c,{}).then(function(a){b.connected=!0;b.token=a.access_token;b.refreshToken=a.refresh_token;console.debug("[DR Api Library] Anonymous token obtained: "+b.token);b.tokenStartTime=
(new Date).getTime()/1E3;b.tokenExpirationTime=(new Date).getTime()/1E3+parseInt(a.expires_in);return a}).fail(function(){console.debug("[DR Api Library] Token failure. Application could not obtain an anonymous token.");b.reset();throw b.createServerErrorResponse();})};e.prototype.getRefreshToken=function(){var a=d.connection.URI.BASE_URL+d.connection.URI.ANONYMOUS_LOGIN,b=this,c={client_id:this.apikey,ts:(new Date).getTime(),grant_type:"refresh_token",refresh_token:this.refreshToken};return this.connection.submitForm(a,
c,{}).then(function(a){b.connected=!0;b.token=a.access_token;b.refreshToken=a.refresh_token;console.debug("[DR Api Library] Anonymous token obtained using Refresh Token: "+b.token);b.tokenStartTime=(new Date).getTime()/1E3;b.tokenExpirationTime=(new Date).getTime()/1E3+parseInt(a.expires_in);return a}).fail(function(){console.debug("[DR Api Library] Token failure. Application could not obtain an anonymous token using a refresh token.");b.refreshToken=null;var a={status:401,error:{}};a.error.errors=
{};a.error.errors.error={code:"refresh_token_invalid",description:"The Refresh Token is invalid"};throw a;})};e.prototype.forceRefreshToken=function(){return this.getRefreshToken()};e.prototype.forceResetSession=function(){this.reset();return this.anonymousLogin()};e.prototype.reset=function(){this.refreshToken=this.token=null;this.authenticated=this.connected=!1;this.tokenExpirationTime=this.tokenStartTime=null};e.prototype.authenticate=function(a){var b=this;if(!this.connected)return this.createDisconnectedError();
a=this.authManager.login(this.token,a);a.then(function(a){if(a.token!="")b.token=a.token,b.authenticated=!0,b.refreshToken=null,b.tokenStartTime=(new Date).getTime()/1E3,b.tokenExpirationTime=(new Date).getTime()/1E3+parseInt(a.expires_in),console.debug("[DR Api Library] Authenticated token obtained: "+b.token);return a.token});return a};e.prototype.disconnect=function(){this.token=null;this.connected=this.authenticated=!1;var a=b.defer();a.resolve();return a.promise};e.prototype.logout=function(){if(!this.connected)return this.createDisconnectedError();
if(this.authenticated)return this.reset(),this.anonymousLogin();else{var a=b.defer();a.resolve();return a.promise}};e.prototype.handleExpansion=function(a,b){var c=this;return a.then(function(a){return c.expand(a,b)})};e.prototype.expand=function(a,c){var d=getAttribute(a,c),e=[],j=is_array(d);if(j)for(var k=0;k<d.length;k++)e.push(this.retrieve(d[k].uri,{}));else e.push(this.retrieve(d.uri,{}));return b.all(e).then(function(b){if(j){setAttribute(a,c,[]);for(var d=getAttribute(a,c),e=0;e<b.length;e++)d.push(b[e])}else setAttribute(a,
c,b[0]);return a})};return e});
define("service/CartService",["service/BaseService","Config"],function(d,a){return d.extend({uri:a.service.URI.CART,addLineItem:function(a,b,d,f){return this.makeRequest(this.session.create(b?b:a.addProductToCart.uri,d),f)},get:function(a,b){return this.makeRequest(this.session.retrieve(this.uri,a),b)},removeLineItem:function(a,b,d){return this.makeRequest(this.session.remove(a.uri,b),d)},getShippingOptions:function(c,b){return this.makeRequest(this.session.retrieve(a.service.URI.CART_SHIPPING_OPTIONS,c),
b)},getOffers:function(c,b,d){return this.makeRequest(this.session.retrieve(this.replaceTemplate(a.service.URI.CART_OFFERS,{popName:c}),b),d)},applyShippingOption:function(c,b){return this.makeRequest(this.session.create(a.service.URI.CART_APPLY_SHIPPING_OPTION,c),b)},applyShopper:function(c,b){return this.makeRequest(this.session.create(a.service.URI.CART_APPLY_SHOPPER,c),b)},submit:function(c,b){return this.makeRequest(this.session.create(a.service.URI.ORDERS,c),b)}})});
define("service/CategoryService",["service/BaseService","Config"],function(d,a){return d.extend({uri:a.service.URI.CATEGORIES})});
define("service/ProductService",["service/BaseService","Config"],function(d,a){return d.extend({uri:a.service.URI.PRODUCTS,listProductsByCategory:function(c,b,d){return this.makeRequest(this.session.retrieve(this.replaceTemplate(a.service.URI.PRODUCTS_BY_CATEGORY,{categoryId:c}),b),d)},search:function(c,b){return this.makeRequest(this.session.retrieve(a.service.URI.PRODUCTS_SEARCH,c),b)},getProductsByIds:function(a,b){return this.makeRequest(this.session.retrieve(this.uri,a),b)}})});
define("service/OfferService",["service/BaseService","Config"],function(d,a){return d.extend({uri:a.service.URI.OFFERS,list:function(a,b,d){return this.makeRequest(this.session.retrieve(this.replaceTemplate(this.uri,{popName:a}),b),d)},get:function(a,b,d,f){return this.makeRequest(this.session.retrieve(this.replaceTemplate(this.uri,{popName:a})+"/"+b,d),f)}})});
define("service/ProductOfferService",["service/BaseService","Config"],function(d,a){return d.extend({uri:a.service.URI.PRODUCT_OFFERS,list:function(a,b,d,f){return this.makeRequest(this.session.retrieve(this.replaceTemplate(this.uri,{popName:a,offerId:b}),d),f)},get:function(a,b,d,f,h){return this.makeRequest(this.session.retrieve(this.replaceTemplate(this.uri,{popName:a,offerId:b})+"/"+d,f),h)}})});define("service/OrderService",["service/BaseService","Config"],function(d,a){return d.extend({uri:a.service.URI.ORDERS})});
define("Client","Config,q,Util,connection/Session,service/CartService,service/CategoryService,service/ProductService,service/OfferService,service/ProductOfferService,service/ShopperService,service/OrderService,AsyncRequester".split(","),function(d,a,c,b,e,f,h,g,i,j,k,l){if(!window.console)window.console={};if(!window.console.log)window.console.log=function(){};return l.extend({init:function(a,m){this.options={env:"prod",authElementId:"",authRedirectUrl:d.config.DEFAULT_REDIRECT_URI,authMode:d.authMode.IFRAME};
this.options=c.merge(this.options,m);this.setEnvironment(this.options.env);this.session=new b(a,this.createAuthConfig(a,this.options));this.cart=new e(this);this.categories=new f(this);this.products=new h(this);this.offers=new g(this);this.productOffers=new i(this);this.shopper=new j(this);this.orders=new k(this);this._super(this.session)},setEnvironment:function(a){d.connection.URI.BASE_URL=a=="dev"?d.connection.URI.DEV_BASE_URL:d.connection.URI.PRD_BASE_URL},createAuthConfig:function(a,b){return{elementId:b.authElementId,
authRedirectUrl:b.authRedirectUrl,strategy:b.authMode,client_id:a}},connect:function(a){return this.makeRequest(this.session.anonymousLogin(),a)},forceRefreshToken:function(a){return this.makeRequest(this.session.forceRefreshToken(),a)},forceResetSession:function(a){return this.makeRequest(this.session.forceResetSession(),a)},login:function(a,b){return this.makeRequest(this.session.authenticate(b),a)},logout:function(a){return this.makeRequest(this.session.logout(),a)},disconnect:function(a){return this.makeRequest(this.session.disconnect(),
a)},checkConnection:function(b){var c=a.defer();this.cart.get({fields:"id"},function(){b()});return c.promise},getSessionInfo:function(){return{clientId:this.session.apikey,connected:this.session.connected,authenticated:this.session.authenticated,token:this.session.token,refreshToken:this.session.refreshToken,tokenExpirationTime:this.session.tokenExpirationTime}}})});
define("drapi",["service/ShopperService","auth/AuthManager","Config","Client","Util"],function(d,a,c,b,e){var f={api:{}};f.api.callbacks={editAccount:d.editCallback,auth:a.authCallback};window.dr=f;return{callbacks:{editAccount:d.editCallback,auth:a.authCallback},Client:b,authModes:c.authMode,util:e}});