/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

define("Class",[],function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,n=function(){};return n.extend=function(n){function o(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var i=new this;e=!1;for(var s in n)i[s]=typeof n[s]=="function"&&typeof r[s]=="function"&&t.test(n[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);return this._super=n,i}}(s,n[s]):n[s];return o.prototype=i,o.prototype.constructor=o,o.extend=arguments.callee,o},n}),define("AsyncRequester",["Class"],function(e){var t=e.extend({init:function(e){this.session=e},makeRequest:function(e,t){var n=this,r=e.fail(function(e){return n.invalidTokenHandler(e)}).fail(function(e){return n.adaptError(e)});if(!t)return r;var i=this.getCallbacks(t);r.then(i.success,i.error).end()},invalidTokenHandler:function(e){throw e.status==0&&(e.status=401,e.error={},e.error.errors={},e.error.errors.error={code:"Unauthorized",description:"Invalid token"},this.session.disconnect()),e},failRequest:function(e,t){if(!t){var n=Q.defer();return n.reject(e),n.promise}cb.error(e)},load:function(e,t,n){return e&&e.uri?this.makeRequest(this.session.retrieve(e.uri,t),n):this.failRequest("The resource does not provide a URI",n)},adaptError:function(e){throw e.error&&e.error.errors&&e.error.errors.error&&(e.error=e.error.errors.error),{status:e.status,details:e}},getCallbacks:function(e){var t=this,n={};return e||(e={}),n.error=function(n){e.error&&typeof e.error=="function"?(e.error(n),e.callDefaultErrorHandler&&t.options.error&&typeof t.options.error=="function"&&t.options.error(n)):t.options.error&&typeof t.options.error=="function"&&t.options.error(n)},n.success=function(n){e.success&&typeof e.success=="function"?e.success(n):e&&typeof e=="function"?e(n):t.options.success&&typeof t.options.success=="function"&&t.options.success(n)},n}});return t}),define("service/BaseService",["AsyncRequester"],function(e){return e.extend({init:function(e){if(!e)throw"Client must be instantiated";this._super(e.session),this.client=e,this.options=e.options},get:function(e,t,n){var r=this.uri+"/"+e;return this.makeRequest(this.session.retrieve(r,t),n)},list:function(e,t){return this.makeRequest(this.session.retrieve(this.uri,e),t)},parseResponse:function(e){return e},replaceTemplate:function(e,t){for(var n in t)e=e.replace("{"+n+"}",t[n]);return e}})}),define("Util",[],function(){var e={};return e.namespace=function(e){var t=e.split("."),n=window,r="";for(var i=0,s=t.length;i<s;i++)r=t[i],n[r]=n[r]||{},n=n[r];return n},e.is_array=function(e){return typeof e=="object"&&e instanceof Array},e.is_string=function(e){return typeof e=="string"},e.getAttribute=function(e,t){var n=t.split("."),r=e,i="";for(var s=0,o=n.length;s<o;s++)i=n[s],r[i]=r[i]||{},r=r[i];return r},e.setAttribute=function(e,t,n){var r=t.split("."),i=e,s="";for(var o=0,u=r.length;o<u-1;o++)s=r[o],i[s]=i[s]||{},i=i[s];i[r[u-1]]=n},e.merge=function(e,t){for(var n in t)e[n]=t[n];return e},e.isAbsoluteUri=function(e){return e.lastIndexOf("http",0)===0},e.Error=function(e){this.message=e},e.getQueryStringParam=function(e,t){var n=(new RegExp("[\\?&]"+t+"=([^&#]*)")).exec(e);return n?n[1]||0:""},e.getCurrentPath=function(){var e=window.location.href.replace(window.location.hash,"");return e.substring(0,e.lastIndexOf("/"))},e}),define("Config",["Util"],function(e){var t={};return t.authMode={POPUP:"POPUP",IFRAME:"IFRAME",WINDOW:"WINDOW"},t.config={AUTH_FRAME_ID:"drApiAuthFrame",DEFAULT_REDIRECT_URI:e.getCurrentPath()+"/drapi-auth.html",EDIT_ACCOUNT_FRAME_ID:"drEditAccountFrame",EDIT_ACCOUNT_REDIRECT_URI:e.getCurrentPath()+"/drapi-editaccount.html"},t.connection={},t.connection.URI={BASE_URL:null,DEV_BASE_URL:"http://23.21.197.49/",PRD_BASE_URL:"http://23.21.197.49/",VERSION:"v1",ANONYMOUS_LOGIN:"oauth20/token",LOGIN:"oauth20/authorize"},t.connection.TYPE={XML:"1",JSON:"2",TEXT:"3",UNSIGNED_BYTES:"4"},t.service={},t.service.URI={CATEGORIES:"shoppers/me/categories",PRODUCTS:"shoppers/me/products",PRODUCTS_BY_CATEGORY:"shoppers/me/categories/{categoryId}/products",OFFERS:"shoppers/me/point-of-promotions/{popName}/offers",PRODUCT_OFFERS:"shoppers/me/point-of-promotions/{popName}/offers/{offerId}/product-offers",PRODUCTS_SEARCH:"/shoppers/me/product-search",CART:"shoppers/me/carts/active",CART_LINE_ITEMS:"shoppers/me/carts/active/line-items",CART_OFFERS:"shoppers/me/carts/active/point-of-promotions/{popName}/offers",CART_APPLY_SHOPPER:"shoppers/me/carts/active/apply-shopper",CART_SHIPPING_OPTIONS:"shoppers/me/carts/active/shipping-options",CART_APPLY_SHIPPING_OPTION:"shoppers/me/carts/active/apply-shipping-option",SHOPPER:"shoppers/me",SHOPPER_PAYMENT_OPTION:"shoppers/me/payment-options",SHOPPER_ACCOUNT:"shoppers/me/account",ORDERS:"shoppers/me/orders",ORDER_SHIPPING_ADDRESS:"shoppers/me/orders/{orderId}/shipping-address",ORDER_BILLING_ADDRESS:"shoppers/me/orders/{orderId}/billing-address",ADDRESS:"shoppers/me/addresses"},t}),function(e){if(typeof define=="function")define("q",[],e);else if(typeof exports=="object")e(void 0,exports);else if(typeof ses!="undefined"){if(!ses.ok())return;ses.makeQ=function(){var t={};return e(void 0,t)}}else e(void 0,Q={})}(function(e,t){function v(e){return d(e)==="[object StopIteration]"||e instanceof ReturnValue}function m(){function o(n){if(!e)return;return t=k(n),c(e,function(e,n){i(function(){t.promiseSend.apply(t,n)})},void 0),e=void 0,t}var e=[],t,n=h(m.prototype),s=h(y.prototype);return s.promiseSend=function(){var n=l(arguments);e?e.push(n):i(function(){t.promiseSend.apply(t,n)})},s.valueOf=function(){return e?s:t.valueOf()},r(s),n.promise=s,n.resolve=o,n.reject=function(e){return o(C(e))},n}function g(e){var t=m();return U(e,void 0,t.resolve,t.reject).fail(t.reject),t.promise}function y(e,t,n,i){t===void 0&&(t=function(e){return C(new Error("Promise does not support operation: "+e))});var s=h(y.prototype);return s.promiseSend=function(n,r){var i=l(arguments,2),o;try{e[n]?o=e[n].apply(s,i):o=t.apply(s,[n].concat(i))}catch(u){o=C(u)}r(o)},n&&(s.valueOf=n),i&&(s.promiseRejected=!0),r(s),s}function b(e){return Object(e)!==e?e:e.valueOf()}function w(e){return e&&typeof e.promiseSend=="function"}function E(e){return S(e)||x(e)}function S(e){return!w(b(e))}function x(e){return e=b(e),e&&!!e.promiseRejected}function C(e){var t=y({when:function(t){if(t){var n=T.indexOf(this);n!==-1&&(N.splice(n,1),T.splice(n,1))}return t?t(e):C(e)}},function(n){return C(e)},function n(){return C(e)},!0);return T.push(t),N.push(e),t}function k(e){if(w(e))return e;if(e&&typeof e.then=="function"){var t=m();return e.then(t.resolve,t.reject),t.promise}return y({when:function(t){return e},get:function(t){return e[t]},put:function(t,n){return e[t]=n},del:function(t){return delete e[t]},post:function(t,n){return e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},fapply:function(t){return e.apply(void 0,t)},viewInfo:function(){function r(e){n[e]||(n[e]=typeof t[e])}var t=e,n={};while(t)Object.getOwnPropertyNames(t).forEach(r),t=Object.getPrototypeOf(t);return{type:typeof e,properties:n}},keys:function(){return keys(e)}},void 0,function n(){return e})}function L(e){return y({isDef:function(){}},function(n){var r=l(arguments);return B.apply(void 0,[e].concat(r))},function(){return b(e)})}function A(e,t){return e=k(e),t?y({viewInfo:function(){return t}},function(n){var r=l(arguments);return B.apply(void 0,[e].concat(r))},function(){return b(e)}):B(e,"viewInfo")}function O(e){return A(e).when(function(t){var n;t.type==="function"?n=function(){return q(e,void 0,arguments)}:n={};var r=t.properties||{};return p(r).forEach(function(t){r[t]==="function"&&(n[t]=function(){return I(e,t,arguments)})}),k(n)})}function M(e,t,n){function o(e){try{return t?t(e):e}catch(n){return C(n)}}function u(e){try{return n?n(e):C(e)}catch(e){return C(e)}}var r=m(),s=!1;return i(function(){k(e).promiseSend("when",function(e){if(s)return;s=!0,k(e).promiseSend("when",function(e){r.resolve(o(e))},function(e){r.resolve(u(e))})},function(e){if(s)return;s=!0,r.resolve(u(e))})}),r.promise}function _(e,t,n){return M(e,function(e){return t.apply(void 0,e)},n)}function D(e){return function(){function t(e,t){var s;try{s=n[e](t)}catch(o){return v(o)?o.value:C(o)}return M(s,r,i)}var n=e.apply(this,arguments),r=t.bind(t,"send"),i=t.bind(t,"throw");return r()}}function P(e){throw new ReturnValue(e)}function H(e){return function(t){var n=l(arguments,1);return B.apply(void 0,[t,e].concat(n))}}function B(e,t){var n=m(),r=l(arguments,2);return e=k(e),i(function(){e.promiseSend.apply(e,[t,n.resolve].concat(r))}),n.promise}function j(e,t,n){var r=m();return e=k(e),i(function(){e.promiseSend.apply(e,[t,r.resolve].concat(n))}),r.promise}function F(e){return function(t){var n=l(arguments,1);return j(t,e,n)}}function U(e,t){var n=l(arguments,2);return q(e,t,n)}function z(e){var t=l(arguments,1);return R(e,t)}function W(e,t){var n=l(arguments,2);return function(){var i=n.concat(l(arguments));return q(e,t,i)}}function X(e){var t=l(arguments,1);return function(){var r=t.concat(l(arguments));return R(e,r)}}function V(e){return M(e,function(e){var t=e.length;if(t===0)return k(e);var n=m();return c(e,function(r,i,s){M(i,function(r){e[s]=r,--t===0&&n.resolve(e)}).fail(n.reject)},void 0),n.promise})}function $(e){return M(e,function(e){return M(V(e.map(function(e){return M(e,n,n)})),function(){return e.map(k)})})}function J(e,t){return M(e,void 0,t)}function K(e,t){return M(e,function(e){return M(t(),function(){return e})},function(e){return M(t(),function(){return C(e)})})}function Q(e){M(e,void 0,function(e){i(function(){throw e})})}function G(e,t){var n=m();return M(e,n.resolve,n.reject),setTimeout(function(){n.reject(new Error("Timed out after "+t+"ms"))},t),n.promise}function Y(e,t){t===void 0&&(t=e,e=void 0);var n=m();return setTimeout(function(){n.resolve(e)},t),n.promise}function Z(e,t,n){return tt(e).apply(t,n)}function et(e,t){var n=l(arguments,2);return Z(e,t,n)}function tt(e){if(arguments.length>1){var t=l(arguments,1);e=e.bind.apply(e,t)}return function(){var t=m(),n=l(arguments);return n.push(t.makeNodeResolver()),R(e,n).fail(t.reject),t.promise}}function nt(e,t,n){return Z(e[t],t,n)}function rt(e,t){var n=l(arguments,2);return Z(e[t],t,n)}var n=function(){},r=Object.freeze||n;typeof cajaVM!="undefined"&&(r=cajaVM.def);var i;if(typeof process!="undefined")i=process.nextTick;else if(typeof msSetImmediate=="function")i=msSetImmediate;else if(typeof setImmediate=="function")i=setImmediate;else if(typeof MessageChannel!="undefined"){var s=new MessageChannel,o={},u=o;s.port1.onmessage=function(){o=o.next;var e=o.task;delete o.task,e()},i=function(e){u=u.next={task:e},s.port2.postMessage(0)}}else i=function(e){setTimeout(e,0)};var a;if(Function.prototype.bind){var f=Function.prototype.bind;a=f.bind(f.call)}else a=function(e){return function(t){return e.call.apply(e,arguments)}};var l=a(Array.prototype.slice),c=a(Array.prototype.reduce||function(e,t){var n=0,r=this.length;if(arguments.length===1)do{if(n in this){t=this[n++];break}if(++n>=r)throw new TypeError}while(1);for(;n<r;n++)n in this&&(t=e(t,this[n],n));return t}),h=Object.create||function(e){function t(){}return t.prototype=e,new t},p=Object.keys||function(e){var t=[];for(var n in e)t.push(n);return t},d=Object.prototype.toString;typeof ReturnValue=="undefined"&&((new Function("return this"))().ReturnValue=function(e){this.value=e}),t.nextTick=i,t.defer=m,m.prototype.node=m.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(l(arguments,1)):e.resolve(n)}},t.promise=g,t.makePromise=y,y.prototype.then=function(e,t){return M(this,e,t)},c(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","end"],function(e,n){y.prototype[n]=function(){return t[n].apply(t,[this].concat(l(arguments)))}},void 0),y.prototype.toSource=function(){return this.toString()},y.prototype.toString=function(){return"[object Promise]"},r(y.prototype),t.nearer=b,t.isPromise=w,t.isResolved=E,t.isFulfilled=S,t.isRejected=x;var T=[],N=[];typeof window!="undefined"&&console.log("Should be empty:",N),t.reject=C,t.begin=k,t.resolve=k,t.ref=k,t.master=L,t.viewInfo=A,t.view=O,t.when=M,t.spread=_,t.async=D,t["return"]=P,t.sender=H,t.Method=H,t.send=B,t.dispatch=j,t.dispatcher=F,t.get=F("get"),t.put=F("put"),t["delete"]=t.del=F("del");var I=t.post=F("post");t.invoke=function(e,t){var n=l(arguments,2);return I(e,t,n)};var q=t.apply=F("apply"),R=t.fapply=F("fapply");t.call=U,t["try"]=z,t.fcall=z,t.bind=W,t.fbind=X,t.keys=F("keys"),t.all=V,t.allResolved=$,t["catch"]=t.fail=J,t["finally"]=t.fin=K,t.end=Q,t.timeout=G,t.delay=Y,t.napply=Z,t.ncall=et,t.nbind=tt,t.npost=nt,t.ninvoke=rt,r(t)}),define("view/EditAccountIFrameView",["Config"],function(e){var t=function(t,n,r){this.uri=t+"?redirect_uri="+encodeURIComponent(n),this.id=e.config.EDIT_ACCOUNT_FRAME_ID,this.parentElementId=r.elementId};return t.prototype.open=function(e,t){var n=document.getElementById(this.id);n||(n=this.create());var r=this.uri+"&token="+e;n.onload=function(){this.src==r&&t&&t()},n.src=r},t.prototype.close=function(){console.log("Closing Edit Account IFrame");var e=document.getElementById(this.id);e&&e.parentNode.removeChild(e)},t.prototype.create=function(){var e=document.createElement("iframe");e.id=this.id,e.width="100%",e.height="100%",e.style.margin="auto",e.style.border="none",e.scrolling="auto";var t=this.parentElementId!=""?document.getElementById(this.parentElementId):document.body;return t.appendChild(e),e},t}),define("service/ShopperService",["service/BaseService","Config","q","view/EditAccountIFrameView"],function(e,t,n,r){var i=e.extend({uri:t.service.URI.SHOPPER,get:function(e,t){return this.makeRequest(this.session.retrieve(this.uri,e),t)},getAddresses:function(e,n){var r=t.service.URI.ADDRESS;return this.makeRequest(this.session.retrieve(r,e),n)},getPaymentOptions:function(e,n){var r=t.service.URI.SHOPPER_PAYMENT_OPTION;return this.makeRequest(this.session.retrieve(r,e),n)},editAccount:function(e,s,o){var u=t.connection.URI.BASE_URL+t.connection.URI.VERSION+"/"+t.service.URI.SHOPPER_ACCOUNT,a=n.defer(),f=t.config.EDIT_ACCOUNT_REDIRECT_URI;return this.view=new r(u,f,e),i.currentRequest={defer:a,view:this.view},this.view.open(this.session.token,o),this.makeRequest(a.promise,s)}});return i.editCallback=function(){var e=i.currentRequest;e&&(e.view.close(),e.view=null,i.currentRequest=null,window.focus(),e.defer.resolve())},i}),define("view/AuthViewUtil",[],function(){return{buildUriFromOptions:function(e,t,n){var r=e+"?redirect_uri="+encodeURIComponent(t)+"&response_type=token"+"&client_id="+n.client_id;return r},getUriWithToken:function(e,t){var n=e+"&dr_limited_token="+t;return n}}}),define("view/AuthWindowView",["view/AuthViewUtil","Config"],function(e,t){var n=function(n,r,i){this.uri=e.buildUriFromOptions(n,r,i),this.id=t.config.AUTH_FRAME_ID};return n.prototype.open=function(t,n){this.popup&&this.close();var r=e.getUriWithToken(this.uri,t);this.popup=window.open(r,this.id),this.popup.focus()},n.prototype.close=function(){console.log("Closing Auth popup"),this.popup&&(this.popup.close(),this.popup=null)},n}),define("view/AuthIFrameView",["view/AuthViewUtil","Config"],function(e,t){var n=function(n,r,i){this.uri=e.buildUriFromOptions(n,r,i),this.id=t.config.AUTH_FRAME_ID,this.parentElementId=i.elementId};return n.prototype.open=function(t,n){var r=document.getElementById(this.id);r||(r=this.create());var i=e.getUriWithToken(this.uri,t);r.onload=function(){this.src==i&&n&&n()},r.src=i},n.prototype.close=function(){console.log("Closing Auth IFrame");var e=document.getElementById(this.id);e&&e.parentNode.removeChild(e)},n.prototype.create=function(){var e=document.createElement("iframe");e.id=this.id,e.width="100%",e.height="100%",e.style.margin="auto",e.style.border="none",e.scrolling="auto";var t=this.parentElementId!=""?document.getElementById(this.parentElementId):document.body;return t.appendChild(e),e},n.prototype.AddOnLoadedHandler=function(){authFrame},n}),define("auth/AuthManager",["q","view/AuthWindowView","view/AuthIFrameView"],function(e,t,n){var r=function(e,r){this.redirectUri=r.authRedirectUrl,this.uri=e,this.views={IFRAME:n,WINDOW:t},this.view=this.createView(r.strategy,r)};return r.prototype.createView=function(e,t){return new this.views[e](this.uri,this.redirectUri,t)},r.prototype.login=function(t,n){var i=e.defer();return r.currentRequest={defer:i,view:this.view},this.view.open(t,n),i.promise},r.authCallback=function(e,t,n,i){var s=r.currentRequest;if(s){s.view.close(),s.view=null,r.currentRequest=null,window.focus();if(!n){var o={token:e,expires_in:t};s.defer.resolve(o)}else{var u={error:n,error_description:i};s.defer.reject(u)}}},r.getError=function(e){switch(e){case"invalid_request":return{error:e,error_description:"Invalid Request. Please check the parameters."}}},r}),define("Ajax",["q"],function(e){var t={};return t.doAjax=function(t,n,r,i,s){var o=e.defer(),u=this.createRequest();return u.onreadystatechange=function(){if(u.readyState==4){var e=u.responseText;e!=""&&(e=JSON.parse(e));if(u.status!=""&&u.status<300)o.resolve(e);else{var t=e.Exception?e.Exception.Error:e;o.reject({status:u.status,error:t})}}},this.sendRequest(t,n,r,i,u,s),o.promise},t.createRequest=function(){try{req=new XMLHttpRequest}catch(e){try{req=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{req=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){req=!1}}}return req},t.sendRequest=function(e,t,n,r,i,s){var o=this.utf8Encode(this.getQueryString(n)),u=e;o!=""&&(u+=(e.indexOf("?")>0?"&":"?")+o),i.open(t,u,!0),i=this.setHeader(r,i);if(s){var a=r["Content-Type"];a=="application/x-www-form-urlencoded"&&(s=this.utf8Encode(this.getQueryString(s))),i.send(s)}else i.send()},t.getQueryString=function(e){var t="";for(var n in e)n&&(t+=n+"="+e[n]+"&");return t.substring(0,t.length-1)},t.setHeader=function(e,t){t.setRequestHeader("Accept","application/json");for(var n in e)t.setRequestHeader(n,e[n]);return t},t.utf8Encode=function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t},t.isEmpty=function(e){for(var t in e)return!1;return!0},t}),define("connection/Connection",["Config","Ajax","Util"],function(e,t,n){var r=function(){console.log("Using real Connection"),this.baseUrl=e.connection.URI.BASE_URL+e.connection.URI.VERSION+"/"};return r.prototype.create=function(e,t,n,r){return this.request(e,"POST",t,n,r)},r.prototype.retrieve=function(e,t,n,r){return this.request(e,"GET",t,n,r)},r.prototype.update=function(e,t,n){return this.request(e,"PUT",t,n)},r.prototype.remove=function(e,t,n){return this.request(e,"DELETE",t,n)},r.prototype.submitForm=function(e,t,n){return n=n||{},n["Content-Type"]="application/x-www-form-urlencoded",this.request(e,"POST",{},n,t)},r.prototype.request=function(e,r,i,s,o){return n.isAbsoluteUri(e)||(e=this.baseUrl+e),t.doAjax(e,r,i,s,o)},r}),define("connection/Session",["Config","connection/Connection","auth/AuthManager","q"],function(e,t,n,r){var i=function(r,i){this.apikey=r,this.connection=new t,this.authManager=new n(e.connection.URI.BASE_URL+e.connection.URI.LOGIN,i),this.reset()};return i.prototype.createErrorPromise=function(e){console.log("Operation not allowed: "+e);var t=this.createServerErrorResponse(),n=r.defer();return n.reject(t),n.promise},i.prototype.createDisconnectedError=function(){return this.createErrorPromise("You must be connected to the server in order to use the API")},i.prototype.createServerErrorResponse=function(){var e={},t={};return t.code="server_error",t.description="Service Temporaly Unavailable. Please try again later or contact the System Administrator.",e.status=500,e.error={},e.error.errors={},e.error.errors.error=t,e},i.prototype.create=function(e,t){if(!this.connected)return this.createDisconnectedError();var n={};n.Authorization="bearer "+this.token;var r=this.connection.create(e,t,n).then(function(e){for(var t in e)if(t)return e[t]});return r},i.prototype.remove=function(e,t){if(!this.connected)return this.createDisconnectedError();var n={};n.Authorization="bearer "+this.token,t||(t={}),t.client_id=this.apikey;var r=this.connection.remove(e,t,n).then(function(e){for(var t in e)if(t)return e[t]});return r},i.prototype.retrieve=function(e,t){if(!this.connected)return this.createDisconnectedError();var n={};n.Authorization="bearer "+this.token,t||(t={}),t.client_id=this.apikey;var r=this,i=this.connection.retrieve(e,t,n).then(function(e){for(var t in e)if(t)return e[t]});return i},i.prototype.errorHandle=function(e){},i.prototype.anonymousLogin=function(){var t=e.connection.URI.BASE_URL+e.connection.URI.ANONYMOUS_LOGIN,n=this,r=new Date;if(this.refreshToken)return this.getRefreshToken();var i={client_id:this.apikey,ts:r.getTime(),grant_type:"password",username:"anonymous",password:"anonymous"};return this.connection.submitForm(t,i,{}).then(function(e){return n.connected=!0,n.token=e.access_token,n.refreshToken=e.refresh_token,console.debug("[DR Api Library] Anonymous token obtained: "+n.token),n.tokenStartTime=(new Date).getTime()/1e3,n.tokenExpirationTime=(new Date).getTime()/1e3+parseInt(e.expires_in),e}).fail(function(e){console.debug("[DR Api Library] Token failure. Application could not obtain an anonymous token."),n.reset();var t=n.createServerErrorResponse();throw t})},i.prototype.getRefreshToken=function(){var t=e.connection.URI.BASE_URL+e.connection.URI.ANONYMOUS_LOGIN,n=this,r=new Date,i={client_id:this.apikey,ts:r.getTime(),grant_type:"refresh_token",refresh_token:this.refreshToken};return this.connection.submitForm(t,i,{}).then(function(e){return n.connected=!0,n.token=e.access_token,n.refreshToken=e.refresh_token,console.debug("[DR Api Library] Anonymous token obtained using Refresh Token: "+n.token),n.tokenStartTime=(new Date).getTime()/1e3,n.tokenExpirationTime=(new Date).getTime()/1e3+parseInt(e.expires_in),e}).fail(function(e){console.debug("[DR Api Library] Token failure. Application could not obtain an anonymous token using a refresh token."),n.refreshToken=null;var t={},r={};throw r.code="refresh_token_invalid",r.description="The Refresh Token is invalid",t.status=401,t.error={},t.error.errors={},t.error.errors.error=r,t})},i.prototype.forceRefreshToken=function(){return this.getRefreshToken()},i.prototype.forceResetSession=function(){return this.reset(),this.anonymousLogin()},i.prototype.reset=function(){this.token=null,this.refreshToken=null,this.connected=!1,this.authenticated=!1,this.tokenStartTime=null,this.tokenExpirationTime=null},i.prototype.authenticate=function(e){var t=this;if(!this.connected)return this.createDisconnectedError();var n=this.authManager.login(this.token,e);return n.then(function(e){return e.token!=""&&(t.token=e.token,t.authenticated=!0,t.refreshToken=null,t.tokenStartTime=(new Date).getTime()/1e3,t.tokenExpirationTime=(new Date).getTime()/1e3+parseInt(e.expires_in),console.debug("[DR Api Library] Authenticated token obtained: "+t.token)),e.token}),n},i.prototype.disconnect=function(){this.token=null,this.authenticated=!1,this.connected=!1;var e=r.defer();return e.resolve(),e.promise},i.prototype.logout=function(){if(!this.connected)return this.createDisconnectedError();if(this.authenticated)return this.reset(),this.anonymousLogin();var e=r.defer();return e.resolve(),e.promise},i.prototype.handleExpansion=function(e,t){var n=this;return e.then(function(e){return n.expand(e,t)})},i.prototype.expand=function(e,t){var n=this,i=getAttribute(e,t),s=[],o=is_array(i);if(o)for(var u=0;u<i.length;u++){var a=i[u];s.push(n.retrieve(a.uri,{}))}else s.push(n.retrieve(i.uri,{}));return r.all(s).then(function(n){if(o){setAttribute(e,t,[]);var r=getAttribute(e,t);for(var i=0;i<n.length;i++)r.push(n[i])}else setAttribute(e,t,n[0]);return e})},i}),define("service/CartService",["service/BaseService","Config"],function(e,t){return e.extend({uri:t.service.URI.CART,addLineItem:function(e,t,n,r){var i;return t?i=t:i=e.addProductToCart.uri,this.makeRequest(this.session.create(i,n),r)},get:function(e,t){return this.makeRequest(this.session.retrieve(this.uri,e),t)},removeLineItem:function(e,t,n){return this.makeRequest(this.session.remove(e.uri,t),n)},getShippingOptions:function(e,n){var r=t.service.URI.CART_SHIPPING_OPTIONS;return this.makeRequest(this.session.retrieve(r,e),n)},getOffers:function(e,n,r){var i=this.replaceTemplate(t.service.URI.CART_OFFERS,{popName:e});return this.makeRequest(this.session.retrieve(i,n),r)},applyShippingOption:function(e,n){var r=t.service.URI.CART_APPLY_SHIPPING_OPTION;return this.makeRequest(this.session.create(r,e),n)},applyShopper:function(e,n){var r=t.service.URI.CART_APPLY_SHOPPER;return this.makeRequest(this.session.create(r,e),n)},submit:function(e,n){var r=t.service.URI.ORDERS;return this.makeRequest(this.session.create(r,e),n)}})}),define("service/CategoryService",["service/BaseService","Config"],function(e,t){return e.extend({uri:t.service.URI.CATEGORIES})}),define("service/ProductService",["service/BaseService","Config"],function(e,t){return e.extend({uri:t.service.URI.PRODUCTS,listProductsByCategory:function(e,n,r){var i=this.replaceTemplate(t.URI.PRODUCTS_BY_CATEGORY,{categoryId:e});return this.makeRequest(this.session.retrieve(i,n),r)},search:function(e,n){var r=t.URI.PRODUCTS_SEARCH;return this.makeRequest(this.session.retrieve(r,e),n)},getProductsByIds:function(e,t){return this.makeRequest(this.session.retrieve(this.uri,e),t)}})}),define("service/OfferService",["service/BaseService","Config"],function(e,t){return e.extend({uri:t.service.URI.OFFERS,list:function(e,t,n){var r=this.replaceTemplate(this.uri,{popName:e});return this.makeRequest(this.session.retrieve(r,t),n)},get:function(e,t,n,r){var i=this.replaceTemplate(this.uri,{popName:e})+"/"+t;return this.makeRequest(this.session.retrieve(i,n),r)}})}),define("service/ProductOfferService",["service/BaseService","Config"],function(e,t){return e.extend({uri:t.service.URI.PRODUCT_OFFERS,list:function(e,t,n,r){var i=this.replaceTemplate(this.uri,{popName:e,offerId:t});return this.makeRequest(this.session.retrieve(i,n),r)},get:function(e,t,n,r,i){var s=this.replaceTemplate(this.uri,{popName:e,offerId:t})+"/"+n;return this.makeRequest(this.session.retrieve(s,r),i)}})}),define("service/OrderService",["service/BaseService","Config"],function(e,t){return e.extend({uri:t.service.URI.ORDERS})}),define("Client",["Config","q","Util","connection/Session","service/CartService","service/CategoryService","service/ProductService","service/OfferService","service/ProductOfferService","service/ShopperService","service/OrderService","AsyncRequester"],function(e,t,n,r,i,s,o,u,a,f,l,c){window.console||(window.console={}),window.console.log||(window.console.log=function(){});var h=c.extend({init:function(t,c){this.options={env:"prod",authElementId:"",authRedirectUrl:e.config.DEFAULT_REDIRECT_URI,authMode:e.authMode.IFRAME},this.options=n.merge(this.options,c),this.setEnvironment(this.options.env),this.session=new r(t,this.createAuthConfig(t,this.options)),this.cart=new i(this),this.categories=new s(this),this.products=new o(this),this.offers=new u(this),this.productOffers=new a(this),this.shopper=new f(this),this.orders=new l(this),this._super(this.session)},setEnvironment:function(t){t=="dev"?e.connection.URI.BASE_URL=e.connection.URI.DEV_BASE_URL:e.connection.URI.BASE_URL=e.connection.URI.PRD_BASE_URL},createAuthConfig:function(e,t){return{elementId:t.authElementId,authRedirectUrl:t.authRedirectUrl,strategy:t.authMode,client_id:e}},connect:function(e){return this.makeRequest(this.session.anonymousLogin(),e)},forceRefreshToken:function(e){return this.makeRequest(this.session.forceRefreshToken(),e)},forceResetSession:function(e){return this.makeRequest(this.session.forceResetSession(),e)},login:function(e,t){return this.makeRequest(this.session.authenticate(t),e)},logout:function(e){return this.makeRequest(this.session.logout(),e)},disconnect:function(e){return this.makeRequest(this.session.disconnect(),e)},checkConnection:function(e){var n=t.defer();return this.cart.get({fields:"id"},function(t){e()}),n.promise},getSessionInfo:function(){return{clientId:this.session.apikey,connected:this.session.connected,authenticated:this.session.authenticated,token:this.session.token,refreshToken:this.session.refreshToken,tokenExpirationTime:this.session.tokenExpirationTime}}});return h}),define("drapi",["service/ShopperService","auth/AuthManager","Config","Client"],function(e,t,n,r){var i={};return i.api={},i.api.callbacks={editAccount:e.editCallback,auth:t.authCallback},window.dr=i,{callbacks:{editAccount:e.editCallback,auth:t.authCallback},Client:r,authModes:n.authMode}})