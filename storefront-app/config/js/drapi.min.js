(function(a){if(typeof define==="function")define(a);else if(typeof exports==="object")a(void 0,exports);else if(typeof ses!=="undefined"){if(ses.ok())ses.makeQ=function(){return a(void 0,{})}}else a(void 0,Q={})})(function(a,b){function c(){function a(c){if(b)return m=j(c),u(b,function(a,b){k(function(){m.promiseSend.apply(m,b)})},void 0),b=void 0,m}var b=[],m,e=v(c.prototype),f=v(d.prototype);f.promiseSend=function(){var a=h(arguments);b?b.push(a):k(function(){m.promiseSend.apply(m,a)})};f.valueOf=
function(){return b?f:m.valueOf()};p(f);e.promise=f;e.resolve=a;e.reject=function(b){return a(l(b))};return e}function d(a,b,c,e){b===void 0&&(b=function(a){return l(Error("Promise does not support operation: "+a))});var f=v(d.prototype);f.promiseSend=function(c,d){var m=h(arguments,2),e;try{e=a[c]?a[c].apply(f,m):b.apply(f,[c].concat(m))}catch(N){e=l(N)}d(e)};if(c)f.valueOf=c;if(e)f.promiseRejected=!0;p(f);return f}function e(a){return Object(a)!==a?a:a.valueOf()}function g(a){return a&&typeof a.promiseSend===
"function"}function f(a){return!g(e(a))}function B(a){return(a=e(a))&&!!a.promiseRejected}function l(a){var b=d({when:function(b){if(b){var c=w.indexOf(this);c!==-1&&(x.splice(c,1),w.splice(c,1))}return b?b(a):l(a)}},function(){return l(a)},function(){return l(a)},!0);w.push(b);x.push(a);return b}function j(a){if(g(a))return a;if(a&&typeof a.then==="function"){var b=c();a.then(b.resolve,b.reject);return b.promise}return d({when:function(){return a},get:function(b){return a[b]},put:function(b,c){return a[b]=
c},del:function(b){return delete a[b]},post:function(b,c){return a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},fapply:function(b){return a.apply(void 0,b)},viewInfo:function(){function b(a){d[a]||(d[a]=typeof c[a])}for(var c=a,d={};c;)Object.getOwnPropertyNames(c).forEach(b),c=Object.getPrototypeOf(c);return{type:typeof a,properties:d}},keys:function(){return keys(a)}},void 0,function(){return a})}function C(a,b){a=j(a);return b?d({viewInfo:function(){return b}},function(b){var c=h(arguments);
return q.apply(void 0,[a].concat(c))},function(){return e(a)}):q(a,"viewInfo")}function i(a,b,d){function e(a){try{return b?b(a):a}catch(c){return l(c)}}function f(a){try{return d?d(a):l(a)}catch(b){return l(b)}}var g=c(),h=!1;k(function(){j(a).promiseSend("when",function(a){h||(h=!0,j(a).promiseSend("when",function(a){g.resolve(e(a))},function(a){g.resolve(f(a))}))},function(a){h||(h=!0,g.resolve(f(a)))})});return g.promise}function D(a){return function(b){var c=h(arguments,1);return q.apply(void 0,
[b,a].concat(c))}}function q(a,b){var d=c(),e=h(arguments,2),a=j(a);k(function(){a.promiseSend.apply(a,[b,d.resolve].concat(e))});return d.promise}function E(a,b,d){var e=c(),a=j(a);k(function(){a.promiseSend.apply(a,[b,e.resolve].concat(d))});return e.promise}function n(a){return function(b){var c=h(arguments,1);return E(b,a,c)}}function F(a,b){var c=h(arguments,2);return y(a,b,c)}function G(a){var b=h(arguments,1);return z(a,b)}function H(a){return i(a,function(a){var b=a.length;if(b===0)return j(a);
var d=c();u(a,function(c,M,e){i(M,function(c){a[e]=c;--b===0&&d.resolve(a)}).fail(d.reject)},void 0);return d.promise})}function t(a,b,c){return I(a).apply(b,c)}function I(a){if(arguments.length>1)var b=h(arguments,1),a=a.bind.apply(a,b);return function(){var b=c(),d=h(arguments);d.push(b.makeNodeResolver());z(a,d).fail(b.reject);return b.promise}}var A=function(){},p=Object.freeze||A;if(typeof cajaVM!=="undefined")p=cajaVM.def;var k;if(typeof process!=="undefined")k=process.nextTick;else if(typeof msSetImmediate===
"function")k=msSetImmediate;else if(typeof setImmediate==="function")k=setImmediate;else if(typeof MessageChannel!=="undefined"){var J=new MessageChannel,r={},K=r;J.port1.onmessage=function(){r=r.next;var a=r.task;delete r.task;a()};k=function(a){K=K.next={task:a};J.port2.postMessage(0)}}else k=function(a){setTimeout(a,0)};var o;Function.prototype.bind?(o=Function.prototype.bind,o=o.bind(o.call)):o=function(a){return function(b){return a.call.apply(a,arguments)}};var h=o(Array.prototype.slice),u=
o(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(arguments.length===1){do{if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError;}while(1)}for(;c<d;c++)c in this&&(b=a(b,this[c],c));return b}),v=Object.create||function(a){function b(){}b.prototype=a;return new b},O=Object.keys||function(a){var b=[],c;for(c in a)b.push(c);return b},P=Object.prototype.toString;if(typeof ReturnValue==="undefined")(new Function("return this"))().ReturnValue=function(a){this.value=a};b.nextTick=
k;b.defer=c;c.prototype.node=c.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):arguments.length>2?a.resolve(h(arguments,1)):a.resolve(c)}};b.promise=function(a){var b=c();F(a,void 0,b.resolve,b.reject).fail(b.reject);return b.promise};b.makePromise=d;d.prototype.then=function(a,b){return i(this,a,b)};u("isResolved,isFulfilled,isRejected,when,spread,send,get,put,del,post,invoke,keys,apply,call,bind,fapply,fcall,fbind,all,allResolved,view,viewInfo,timeout,delay,catch,finally,fail,fin,end".split(","),
function(a,c){d.prototype[c]=function(){return b[c].apply(b,[this].concat(h(arguments)))}},void 0);d.prototype.toSource=function(){return this.toString()};d.prototype.toString=function(){return"[object Promise]"};p(d.prototype);b.nearer=e;b.isPromise=g;b.isResolved=function(a){return f(a)||B(a)};b.isFulfilled=f;b.isRejected=B;var w=[],x=[];typeof window!=="undefined"&&console.log("Should be empty:",x);b.reject=l;b.begin=j;b.resolve=j;b.ref=j;b.master=function(a){return d({isDef:function(){}},function(b){var c=
h(arguments);return q.apply(void 0,[a].concat(c))},function(){return e(a)})};b.viewInfo=C;b.view=function(a){return C(a).when(function(b){var c;c=b.type==="function"?function(){return y(a,void 0,arguments)}:{};var d=b.properties||{};O(d).forEach(function(b){d[b]==="function"&&(c[b]=function(){return L(a,b,arguments)})});return j(c)})};b.when=i;b.spread=function(a,b,c){return i(a,function(a){return b.apply(void 0,a)},c)};b.async=function(a){return function(){function b(a,f){var g;try{g=c[a](f)}catch(s){return P(s)===
"[object StopIteration]"||s instanceof ReturnValue?s.value:l(s)}return i(g,d,e)}var c=a.apply(this,arguments),d=b.bind(b,"send"),e=b.bind(b,"throw");return d()}};b["return"]=function(a){throw new ReturnValue(a);};b.sender=D;b.Method=D;b.send=q;b.dispatch=E;b.dispatcher=n;b.get=n("get");b.put=n("put");b["delete"]=b.del=n("del");var L=b.post=n("post");b.invoke=function(a,b){var c=h(arguments,2);return L(a,b,c)};var y=b.apply=n("apply"),z=b.fapply=n("fapply");b.call=F;b["try"]=G;b.fcall=G;b.bind=function(a,
b){var c=h(arguments,2);return function(){var d=c.concat(h(arguments));return y(a,b,d)}};b.fbind=function(a){var b=h(arguments,1);return function(){var c=b.concat(h(arguments));return z(a,c)}};b.keys=n("keys");b.all=H;b.allResolved=function(a){return i(a,function(a){return i(H(a.map(function(a){return i(a,A,A)})),function(){return a.map(j)})})};b["catch"]=b.fail=function(a,b){return i(a,void 0,b)};b["finally"]=b.fin=function(a,b){return i(a,function(a){return i(b(),function(){return a})},function(a){return i(b(),
function(){return l(a)})})};b.end=function(a){i(a,void 0,function(a){k(function(){throw a;})})};b.timeout=function(a,b){var d=c();i(a,d.resolve,d.reject);setTimeout(function(){d.reject(Error("Timed out after "+b+"ms"))},b);return d.promise};b.delay=function(a,b){b===void 0&&(b=a,a=void 0);var d=c();setTimeout(function(){d.resolve(a)},b);return d.promise};b.napply=t;b.ncall=function(a,b){var c=h(arguments,2);return t(a,b,c)};b.nbind=I;b.npost=function(a,b,c){return t(a[b],b,c)};b.ninvoke=function(a,
b){var c=h(arguments,2);return t(a[b],b,c)};p(b)});
(function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var g=new this;a=!1;for(var f in c)g[f]=typeof c[f]=="function"&&typeof e[f]=="function"&&b.test(c[f])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);this._super=c;return d}}(f,c[f]):c[f];d.prototype=g;d.prototype.constructor=d;d.extend=arguments.callee;
return d}})();var namespace=function(a){for(var a=a.split("."),b=window,c="",d=0,e=a.length;d<e;d++)c=a[d],b[c]=b[c]||{},b=b[c];return b};function is_array(a){return typeof a=="object"&&a instanceof Array}function is_string(a){return typeof a=="string"}function replaceTemplate(a,b){for(var c in b)a=a.replace("{"+c+"}",b[c]);return a}
var getAttribute=function(a,b){for(var c=b.split("."),d=a,e="",g=0,f=c.length;g<f;g++)e=c[g],d[e]=d[e]||{},d=d[e];return d},setAttribute=function(a,b,c){for(var b=b.split("."),d="",e=0,g=b.length;e<g-1;e++)d=b[e],a[d]=a[d]||{},a=a[d];a[b[g-1]]=c},merge=function(a,b){for(var c in b)a[c]=b[c];return a};isAbsoluteUri=function(a){return a.lastIndexOf("http",0)===0};Error=function(a){this.message=a};function getQueryStringParam(a,b){var c=RegExp("[\\?&]"+b+"=([^&#]*)").exec(a);return!c?"":c[1]||0}
function getCurrentPath(){var a=window.location.href.replace(window.location.hash,"");return a.substring(0,a.lastIndexOf("/"))}var ns=namespace("dr.api.util"),conn=namespace("dr.api.connection");
ns.doAjax=function(a,b,c,d,e){var g=Q.defer(),f=dr.api.util.createRequest();f.onreadystatechange=function(){if(f.readyState==4){var a=f.responseText;a!=""&&(a=JSON.parse(a));f.status!=""&&f.status<300?g.resolve(a):g.reject({status:f.status,error:a.Exception?a.Exception.Error:a})}};dr.api.util.sendRequest(a,b,c,d,f,e);return g.promise};
ns.createRequest=function(){try{req=new XMLHttpRequest}catch(a){try{req=new ActiveXObject("Msxml2.XMLHTTP")}catch(b){try{req=new ActiveXObject("Microsoft.XMLHTTP")}catch(c){req=!1}}}return req};
ns.sendRequest=function(a,b,c,d,e,g){var c=dr.api.util.utf8Encode(dr.api.util.getQueryString(c)),f=a;c!=""&&(f+=(a.indexOf("?")>0?"&":"?")+c);e.open(b,f,!0);e=dr.api.util.setHeader(d,e);g?(d["Content-Type"]=="application/x-www-form-urlencoded"&&(g=dr.api.util.utf8Encode(dr.api.util.getQueryString(g))),e.send(g)):e.send()};ns.getQueryString=function(a){var b="",c;for(c in a)c&&(b+=c+"="+a[c]+"&");return b.substring(0,b.length-1)};
ns.setHeader=function(a,b){b.setRequestHeader("Accept","application/json");for(var c in a)b.setRequestHeader(c,a[c]);return b};ns.utf8Encode=function(a){for(var a=a.replace(/\r\n/g,"\n"),b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):(d>127&&d<2048?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b};ns.isEmpty=function(a){for(var b in a)return!1;return!0};ns=namespace("dr.api");
ns.authMode={POPUP:"POPUP",IFRAME:"IFRAME",WINDOW:"WINDOW"};ns.config={AUTH_FRAME_ID:"drApiAuthFrame",DEFAULT_REDIRECT_URI:getCurrentPath()+"/drapi-auth.html",EDIT_ACCOUNT_FRAME_ID:"drEditAccountFrame",EDIT_ACCOUNT_REDIRECT_URI:getCurrentPath()+"/drapi-editaccount.html"};var nsConn=namespace("dr.api.connection");nsConn.URI={BASE_URL:null,DEV_BASE_URL:"http://23.21.197.49/",PRD_BASE_URL:"http://23.21.197.49/",VERSION:"v1",ANONYMOUS_LOGIN:"oauth20/token",LOGIN:"oauth20/authorize"};
nsConn.TYPE={XML:"1",JSON:"2",TEXT:"3",UNSIGNED_BYTES:"4"};var nsService=namespace("dr.api.service");
nsService.URI={CATEGORIES:"shoppers/me/categories",PRODUCTS:"shoppers/me/products",PRODUCTS_BY_CATEGORY:"shoppers/me/categories/{categoryId}/products",OFFERS:"shoppers/me/point-of-promotions/{popName}/offers",PRODUCT_OFFERS:"shoppers/me/point-of-promotions/{popName}/offers/{offerId}/product-offers",PRODUCTS_SEARCH:"/shoppers/me/product-search",CART:"shoppers/me/carts/active",CART_LINE_ITEMS:"shoppers/me/carts/active/line-items",CART_OFFERS:"shoppers/me/carts/active/point-of-promotions/{popName}/offers",
CART_APPLY_SHOPPER:"shoppers/me/carts/active/apply-shopper",CART_SHIPPING_OPTIONS:"shoppers/me/carts/active/shipping-options",CART_APPLY_SHIPPING_OPTION:"shoppers/me/carts/active/apply-shipping-option",SHOPPER:"shoppers/me",SHOPPER_PAYMENT_OPTION:"shoppers/me/payment-options",SHOPPER_ACCOUNT:"shoppers/me/account",ORDERS:"shoppers/me/orders",ORDER_SHIPPING_ADDRESS:"shoppers/me/orders/{orderId}/shipping-address",ORDER_BILLING_ADDRESS:"shoppers/me/orders/{orderId}/billing-address",ADDRESS:"shoppers/me/addresses"};
ns=namespace("dr.api");
ns.AsyncRequester=Class.extend({init:function(a){this.session=a},makeRequest:function(a,b){if(b){var c=this.getCallbacks(b),d=this;a.fail(function(a){return d.invalidTokenHandler(a)}).then(c.success,c.error).end()}else return a},invalidTokenHandler:function(a){if(a.status==0)a.status=401,a.error={},a.error.errors={},a.error.errors.error={code:"Unauthorized",description:"Invalid token"},this.session.disconnect();throw a;},failRequest:function(a,b){if(b)cb.error(a);else{var c=Q.defer();c.reject(a);
return c.promise}},load:function(a,b,c){return a&&a.uri?this.makeRequest(this.session.retrieve(a.uri,b),c):this.failRequest("The resource does not provide a URI",c)},getCallbacks:function(a){var b=this,c={};a||(a={});c.error=function(c){if(c.error&&c.error.errors&&c.error.errors.error)c.error=c.error.errors.error;a.error&&typeof a.error==="function"?a.error({status:c.status,details:c}):b.options.error&&typeof b.options.error==="function"&&b.options.error({status:c.status,details:c})};c.success=function(c){a.success&&
typeof a.success==="function"?a.success(c):a&&typeof a==="function"?a(c):b.options.success&&typeof b.options.success==="function"&&b.options.success(c)};return c}});var buildUriFromOptions=function(a,b,c){return a+"?redirect_uri="+encodeURIComponent(b)+"&response_type=token&client_id="+c.client_id},getUriWithToken=function(a,b){return a+"&limited_token="+b},ns=namespace("dr.api.view");
ns.AuthIFrameView=function(a,b,c){this.uri=buildUriFromOptions(a,b,c);this.id=dr.api.config.AUTH_FRAME_ID;this.parentElementId=c.elementId};ns.AuthIFrameView.prototype.open=function(a,b){var c=document.getElementById(this.id);c||(c=this.create());var d=getUriWithToken(this.uri,a);c.onload=function(){this.src==d&&b()};c.src=d};ns.AuthIFrameView.prototype.close=function(){console.log("Closing Auth IFrame");var a=document.getElementById(this.id);a&&a.parentNode.removeChild(a)};
ns.AuthIFrameView.prototype.create=function(){var a=document.createElement("iframe");a.id=this.id;a.width="100%";a.height="100%";a.style.margin="auto";a.style.border="none";a.scrolling="auto";(this.parentElementId!=""?document.getElementById(this.parentElementId):document.body).appendChild(a);return a};ns.AuthIFrameView.prototype.AddOnLoadedHandler=function(){};ns=namespace("dr.api.view");ns.AuthWindowView=function(a,b,c){this.uri=buildUriFromOptions(a,b,c);this.id=dr.api.config.AUTH_FRAME_ID};
ns.AuthWindowView.prototype.open=function(a){this.popup&&this.close();a=getUriWithToken(this.uri,a);this.popup=window.open(a,this.id);this.popup.focus()};ns.AuthWindowView.prototype.close=function(){console.log("Closing Auth popup");if(this.popup)this.popup.close(),this.popup=null};ns=namespace("dr.api.view");ns.EditAccountIFrameView=function(a,b,c){this.uri=a+"?redirect_uri="+encodeURIComponent(b);this.id=dr.api.config.EDIT_ACCOUNT_FRAME_ID;this.parentElementId=c.elementId};
ns.EditAccountIFrameView.prototype.open=function(a,b){var c=document.getElementById(this.id);c||(c=this.create());var d=this.uri+"&token="+a;c.onload=function(){this.src==d&&b()};c.src=d};ns.EditAccountIFrameView.prototype.close=function(){console.log("Closing Edit Account IFrame");var a=document.getElementById(this.id);a&&a.parentNode.removeChild(a)};
ns.EditAccountIFrameView.prototype.create=function(){var a=document.createElement("iframe");a.id=this.id;a.width="100%";a.height="100%";a.style.margin="auto";a.style.border="none";a.scrolling="auto";(this.parentElementId!=""?document.getElementById(this.parentElementId):document.body).appendChild(a);return a};ns=namespace("dr.api.auth");
ns.AuthManager=function(a,b){this.redirectUri=b.authRedirectUrl;this.uri=a;this.views={IFRAME:dr.api.view.AuthIFrameView,WINDOW:dr.api.view.AuthWindowView};this.view=this.createView(b.strategy,b)};ns.AuthManager.prototype.createView=function(a,b){return new this.views[a](this.uri,this.redirectUri,b)};ns.AuthManager.prototype.login=function(a,b){var c=Q.defer();dr.api.auth.currentRequest={defer:c,view:this.view};this.view.open(a,b);return c.promise};
ns.authCallback=function(a,b,c,d){var e=dr.api.auth.currentRequest;if(e)e.view.close(),e.view=null,dr.api.auth.currentRequest=null,window.focus(),c?e.defer.reject({error:c,error_description:d}):e.defer.resolve({token:a,expires_in:b})};ns.getError=function(a){switch(a){case "invalid_request":return{error:a,error_description:"Invalid Request. Please check the parameters."}}};var ns=namespace("dr.api.connection"),util=namespace("dr.api.util");
ns.Connection=function(){console.log("Using real Connection");this.baseUrl=dr.api.connection.URI.BASE_URL+dr.api.connection.URI.VERSION+"/"};ns.Connection.prototype.create=function(a,b,c,d){return this.request(a,"POST",b,c,d)};ns.Connection.prototype.retrieve=function(a,b,c,d){return this.request(a,"GET",b,c,d)};ns.Connection.prototype.update=function(a,b,c){return this.request(a,"PUT",b,c)};ns.Connection.prototype.remove=function(a,b,c){return this.request(a,"DELETE",b,c)};
ns.Connection.prototype.submitForm=function(a,b,c){c=c||{};c["Content-Type"]="application/x-www-form-urlencoded";return this.request(a,"POST",{},c,b)};ns.Connection.prototype.request=function(a,b,c,d,e){isAbsoluteUri(a)||(a=this.baseUrl+a);return util.doAjax(a,b,c,d,e)};ns=namespace("dr.api.connection");ns.Session=function(a,b){this.apikey=a;this.connection=new dr.api.connection.Connection;this.authManager=new dr.api.auth.AuthManager(dr.api.connection.URI.BASE_URL+dr.api.connection.URI.LOGIN,b);this.reset()};
ns.Session.prototype.createErrorPromise=function(a){console.log("Operation not allowed: "+a);var a=this.createServerErrorResponse(),b=Q.defer();b.reject(a);return b.promise};ns.Session.prototype.createDisconnectedError=function(){return this.createErrorPromise("You must be connected to the server in order to use the API")};
ns.Session.prototype.createServerErrorResponse=function(){var a={status:500,error:{}};a.error.errors={};a.error.errors.error={code:"server_error",description:"Service Temporaly Unavailable. Please try again later or contact the System Administrator."};return a};ns.Session.prototype.create=function(a,b){if(!this.connected)return this.createDisconnectedError();var c={};c.Authorization="bearer "+this.token;return this.connection.create(a,b,c).then(function(a){for(var b in a)if(b)return a[b]})};
ns.Session.prototype.remove=function(a,b){if(!this.connected)return this.createDisconnectedError();var c={};c.Authorization="bearer "+this.token;b||(b={});b.client_id=this.apikey;return this.connection.remove(a,b,c).then(function(a){for(var b in a)if(b)return a[b]})};ns.Session.prototype.retrieve=function(a,b){if(!this.connected)return this.createDisconnectedError();var c={};c.Authorization="bearer "+this.token;b||(b={});b.client_id=this.apikey;return this.connection.retrieve(a,b,c).then(function(a){for(var b in a)if(b)return a[b]})};
ns.Session.prototype.errorHandle=function(){};
ns.Session.prototype.anonymousLogin=function(){var a=dr.api.connection.URI.BASE_URL+dr.api.connection.URI.ANONYMOUS_LOGIN,b=this,c=new Date;if(this.refreshToken)return this.getRefreshToken();c={client_id:this.apikey,ts:c.getTime(),grant_type:"password",username:"anonymous",password:"anonymous"};return this.connection.submitForm(a,c,{}).then(function(a){b.connected=!0;b.token=a.access_token;b.refreshToken=a.refresh_token;console.debug("[DR Api Library] Anonymous token obtained: "+b.token);b.tokenStartTime=
(new Date).getTime()/1E3;b.tokenExpirationTime=(new Date).getTime()/1E3+parseInt(a.expires_in);return a}).fail(function(){console.debug("[DR Api Library] Token failure. Application could not obtain an anonymous token.");b.reset();throw b.createServerErrorResponse();})};
ns.Session.prototype.getRefreshToken=function(){var a=dr.api.connection.URI.BASE_URL+dr.api.connection.URI.ANONYMOUS_LOGIN,b=this,c={client_id:this.apikey,ts:(new Date).getTime(),grant_type:"refresh_token",refresh_token:this.refreshToken};return this.connection.submitForm(a,c,{}).then(function(a){b.connected=!0;b.token=a.access_token;b.refreshToken=a.refresh_token;console.debug("[DR Api Library] Anonymous token obtained using Refresh Token: "+b.token);b.tokenStartTime=(new Date).getTime()/1E3;b.tokenExpirationTime=
(new Date).getTime()/1E3+parseInt(a.expires_in);return a}).fail(function(){console.debug("[DR Api Library] Token failure. Application could not obtain an anonymous token using a refresh token.");b.refreshToken=null;var a={status:401,error:{}};a.error.errors={};a.error.errors.error={code:"refresh_token_invalid",description:"The Refresh Token is invalid"};throw a;})};
ns.Session.prototype.reset=function(){this.refreshToken=this.token=null;this.authenticated=this.connected=!1;this.tokenExpirationTime=this.tokenStartTime=null};
ns.Session.prototype.authenticate=function(a){var b=this;if(!this.connected)return this.createDisconnectedError();a=this.authManager.login(this.token,a);a.then(function(a){if(a.token!="")b.token=a.token,b.authenticated=!0,b.refreshToken=null,b.tokenStartTime=(new Date).getTime()/1E3,b.tokenExpirationTime=(new Date).getTime()/1E3+parseInt(a.expires_in),console.debug("[DR Api Library] Authenticated token obtained: "+b.token);return a.token});return a};
ns.Session.prototype.disconnect=function(){this.token=null;this.connected=this.authenticated=!1;var a=Q.defer();a.resolve();return a.promise};ns.Session.prototype.logout=function(){if(!this.connected)return this.createDisconnectedError();if(this.authenticated)return this.reset(),this.anonymousLogin();else{var a=Q.defer();a.resolve();return a.promise}};ns.Session.prototype.handleExpansion=function(a,b){var c=this;return a.then(function(a){return c.expand(a,b)})};
ns.Session.prototype.expand=function(a,b){var c=getAttribute(a,b),d=[],e=is_array(c);if(e)for(var g=0;g<c.length;g++)d.push(this.retrieve(c[g].uri,{}));else d.push(this.retrieve(c.uri,{}));return Q.all(d).then(function(c){if(e){setAttribute(a,b,[]);for(var d=getAttribute(a,b),g=0;g<c.length;g++)d.push(c[g])}else setAttribute(a,b,c[0]);return a})};var ns=namespace("dr.api.service"),nsa=namespace("dr.api");
ns.BaseService=nsa.AsyncRequester.extend({init:function(a){if(!a)throw"Client must be instantiated";this._super(a.session);this.client=a;this.options=a.options},get:function(a,b,c){return this.makeRequest(this.session.retrieve(this.uri+"/"+a,b),c)},list:function(a,b){return this.makeRequest(this.session.retrieve(this.uri,a),b)},parseResponse:function(a){return a}});ns=namespace("dr.api.service");
ns.CartService=ns.BaseService.extend({uri:ns.URI.CART,addLineItem:function(a,b,c,d){return this.makeRequest(this.session.create(b?b:a.addProductToCart.uri,c),d)},get:function(a,b){return this.makeRequest(this.session.retrieve(this.uri,a),b)},removeLineItem:function(a,b,c){return this.makeRequest(this.session.remove(a.uri,b),c)},getShippingOptions:function(a,b){return this.makeRequest(this.session.retrieve(dr.api.service.URI.CART_SHIPPING_OPTIONS,a),b)},getOffers:function(a,b,c){return this.makeRequest(this.session.retrieve(replaceTemplate(dr.api.service.URI.CART_OFFERS,
{popName:a}),b),c)},applyShippingOption:function(a,b){return this.makeRequest(this.session.create(dr.api.service.URI.CART_APPLY_SHIPPING_OPTION,a),b)},applyShopper:function(a,b){return this.makeRequest(this.session.create(dr.api.service.URI.CART_APPLY_SHOPPER,a),b)},submit:function(a,b){return this.makeRequest(this.session.create(dr.api.service.URI.ORDERS,a),b)}});ns=namespace("dr.api.service");ns.CategoryService=ns.BaseService.extend({uri:ns.URI.CATEGORIES});ns=namespace("dr.api.service");
ns.OfferService=ns.BaseService.extend({uri:ns.URI.OFFERS,list:function(a,b,c){return this.makeRequest(this.session.retrieve(replaceTemplate(this.uri,{popName:a}),b),c)},get:function(a,b,c,d){return this.makeRequest(this.session.retrieve(replaceTemplate(this.uri,{popName:a})+"/"+b,c),d)}});ns=namespace("dr.api.service");
ns.ProductOfferService=ns.BaseService.extend({uri:ns.URI.PRODUCT_OFFERS,list:function(a,b,c,d){return this.makeRequest(this.session.retrieve(replaceTemplate(this.uri,{popName:a,offerId:b}),c),d)},get:function(a,b,c,d,e){return this.makeRequest(this.session.retrieve(replaceTemplate(this.uri,{popName:a,offerId:b})+"/"+c,d),e)}});var service=namespace("dr.api.service");
ns.ProductService=ns.BaseService.extend({uri:ns.URI.PRODUCTS,listProductsByCategory:function(a,b,c){return this.makeRequest(this.session.retrieve(replaceTemplate(dr.api.service.URI.PRODUCTS_BY_CATEGORY,{categoryId:a}),b),c)},search:function(a,b){return this.makeRequest(this.session.retrieve(dr.api.service.URI.PRODUCTS_SEARCH,a),b)},getProductsByIds:function(a,b){return this.makeRequest(this.session.retrieve(this.uri,a),b)}});ns=namespace("dr.api.service");
ns.ShopperService=ns.BaseService.extend({uri:ns.URI.SHOPPER,get:function(a,b){return this.makeRequest(this.session.retrieve(this.uri,a),b)},getAddresses:function(a,b){return this.makeRequest(this.session.retrieve(dr.api.service.URI.ADDRESS,a),b)},getPaymentOptions:function(a,b){return this.makeRequest(this.session.retrieve(dr.api.service.URI.SHOPPER_PAYMENT_OPTION,a),b)},editAccount:function(a,b,c){var d=dr.api.connection.URI.BASE_URL+dr.api.connection.URI.VERSION+"/"+dr.api.service.URI.SHOPPER_ACCOUNT,
e=Q.defer();this.view=new dr.api.view.EditAccountIFrameView(d,dr.api.config.EDIT_ACCOUNT_REDIRECT_URI,a);dr.api.service.currentRequest={defer:e,view:this.view};this.view.open(this.session.token,c);return this.makeRequest(e.promise,b)}});ns.editCallback=function(){var a=dr.api.service.currentRequest;if(a)a.view.close(),a.view=null,dr.api.auth.currentRequest=null,window.focus(),a.defer.resolve()};ns=namespace("dr.api.service");ns.OrderService=ns.BaseService.extend({uri:ns.URI.ORDERS});ns=namespace("dr.api");
if(!window.console)window.console={};if(!window.console.log)window.console.log=function(){};
ns.Client=ns.AsyncRequester.extend({init:function(a,b){this.options={env:"prod",authElementId:"",authRedirectUrl:dr.api.config.DEFAULT_REDIRECT_URI,authMode:dr.api.authMode.IFRAME};this.options=merge(this.options,b);this.setEnvironment(this.options.env);this.session=new dr.api.connection.Session(a,this.createAuthConfig(a,this.options));this.cart=new dr.api.service.CartService(this);this.categories=new dr.api.service.CategoryService(this);this.products=new dr.api.service.ProductService(this);this.offers=
new dr.api.service.OfferService(this);this.productOffers=new dr.api.service.ProductOfferService(this);this.shopper=new dr.api.service.ShopperService(this);this.orders=new dr.api.service.OrderService(this);this._super(this.session)},setEnvironment:function(a){dr.api.connection.URI.BASE_URL=a=="dev"?dr.api.connection.URI.DEV_BASE_URL:dr.api.connection.URI.PRD_BASE_URL},createAuthConfig:function(a,b){return{elementId:b.authElementId,authRedirectUrl:b.authRedirectUrl,strategy:b.authMode,client_id:a}},
connect:function(a){return this.makeRequest(this.session.anonymousLogin(),a)},login:function(a,b){return this.makeRequest(this.session.authenticate(b),a)},logout:function(a){return this.makeRequest(this.session.logout(),a)},disconnect:function(a){return this.makeRequest(this.session.disconnect(),a)},checkConnection:function(a){var b=Q.defer();this.cart.get({fields:"id"},function(){a()});return b.promise},getSessionInfo:function(){return{connected:this.session.connected,authenticated:this.session.authenticated,
token:this.session.token,tokenExpirationTime:this.session.tokenExpirationTime}}});
